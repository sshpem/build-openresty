name: Build OpenResty with HTTP + Stream Lua (Ubuntu 24.04 amd64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # 1️⃣ 安装编译依赖
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            build-essential \
            wget \
            ca-certificates \
            libpcre3-dev \
            zlib1g-dev \
            libssl-dev \
            perl \
            git \
            curl \
            unzip

      # 2️⃣ 克隆你修改的 OpenResty 源码
      - name: Clone modified OpenResty
        run: |
          git clone https://github.com/stayfocus/openresty.git
          cd openresty
          git checkout main  # 或你想用的分支
          chmod +x ./configure  # 确保 configure 可执行

      # 3️⃣ 编译 OpenResty（开启 HTTP + stream + stream SSL）
      - name: Build OpenResty
        run: |
          cd openresty
          ./configure \
            --prefix=/usr/local/openresty \
            --with-http_ssl_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-stream_realip_module
          make -j$(nproc)
          chmod +x build/install
          sudo make install

      - name: Fix OpenResty executable permissions
        run: |
          sudo chmod +x /usr/local/openresty/bin/* || true
          sudo chmod +x /usr/local/openresty/nginx/sbin/* || true
          sudo chmod +x /usr/local/openresty/luajit/bin/* || true


      # 4️⃣ 验证 resty.core
      - name: Verify resty.core
        run: |
          /usr/local/openresty/nginx/sbin/nginx -V
          /usr/local/openresty/bin/resty -e "print(_VERSION)"
          /usr/local/openresty/bin/resty -e "require 'resty.core'; print('resty.core OK')"

      # 5️⃣ 打包编译产物
      - name: Package artifact
        run: |
          tar czf openresty-ubuntu24-amd64.tar.gz /usr/local/openresty

      # 6️⃣ 上传产物到 GitHub
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openresty-ubuntu24-amd64
          path: openresty-ubuntu24-amd64.tar.gz
