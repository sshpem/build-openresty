name: Build OpenResty ARM64

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-arm64:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: read
      id-token: write

    steps:
      # 1. Checkout this workflow repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up QEMU for ARM64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
          image: docker.io/tonistiigi/binfmt:latest
          cache-image: true

      # 3. Set up Docker Buildx (optional, needed for advanced builds)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Build OpenResty inside ARM64 container
      - name: Build OpenResty for ARM64
        run: |
          mkdir -p build
          docker run --rm -t \
            -v ${{ github.workspace }}/build:/build \
            -w /build \
            --platform linux/arm64 \
            ubuntu:24.04 \
            bash -c "
              apt-get update && \
              apt-get install -y build-essential curl libpcre3-dev libssl-dev perl git make && \
              echo 'Cloning stayfocus/openresty...' && \
              git clone --depth 1 https://github.com/stayfocus/openresty.git src && \
              cd src && \
              ./configure --prefix=/build/openresty-linux-arm64 && \
              make -j$(nproc) && \
              make install
            "

      # 5. Upload compiled artifact
      - name: Upload OpenResty artifact
        uses: actions/upload-artifact@v4
        with:
          name: openresty-linux-arm64
          path: build/openresty-linux-arm64
