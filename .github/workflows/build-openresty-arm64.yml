name: Build OpenResty ARM64 (Docker + QEMU)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # 1️⃣ Checkout repo (可选，如果你 repo 有 workflow 本身)
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      # 2️⃣ 设置 QEMU 支持 ARM64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # 3️⃣ 设置 Docker Buildx（多平台构建）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4️⃣ 编译 OpenResty 在 ARM64 Docker 容器
      - name: Build OpenResty in ARM64 container
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            ubuntu:24.04 bash -eux <<'EOF'

            # 安装编译依赖
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y \
              build-essential \
              wget \
              ca-certificates \
              libpcre3-dev \
              zlib1g-dev \
              libssl-dev \
              perl \
              git \
              curl \
              unzip

            # 克隆你的修改版 OpenResty
            git clone https://github.com/stayfocus/openresty.git
            cd openresty
            git checkout main
            chmod +x ./configure

            # 配置 + 编译 OpenResty
            ./configure \
              --prefix=/usr/local/openresty \
              --with-http_ssl_module \
              --with-stream \
              --with-stream_ssl_module \
              --with-stream_realip_module

            # 并行编译
            make -j$(nproc)

            # 安装（root 用户在容器里可以直接）
            chmod +x build/install
            make install

            # 修复可执行权限
            chmod +x /usr/local/openresty/bin/* || true
            chmod +x /usr/local/openresty/nginx/sbin/* || true
            chmod +x /usr/local/openresty/luajit/bin/* || true

            # 验证 resty.core
            /usr/local/openresty/bin/resty -e "require 'resty.core'; print('resty.core OK')"

            # 打包产物到挂载目录 /work，保证宿主机可见
            tar czf /work/openresty-linux-arm64.tar.gz /usr/local/openresty

          EOF

      # 5️⃣ 可选 debug，确认 tar 包生成
      - name: Debug workspace files
        run: |
          pwd
          ls -lah

      # 6️⃣ 上传 artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openresty-linux-arm64
          path: openresty-linux-arm64.tar.gz
